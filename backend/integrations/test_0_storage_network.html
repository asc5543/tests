<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.6">
<title>harvester_e2e_tests.integrations.test_0_storage_network API documentation</title>
<meta name="description" content="">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source > summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible;min-width:max-content}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin:1em 0}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
/* Collapse source docstrings */
setTimeout(() => {
[...document.querySelectorAll('.hljs.language-python > .hljs-string')]
.filter(el => el.innerHTML.length > 200 && ['"""', "'''"].includes(el.innerHTML.substring(0, 3)))
.forEach(el => {
let d = document.createElement('details');
d.classList.add('hljs-string');
d.innerHTML = '<summary>"""</summary>' + el.innerHTML.substring(3);
el.replaceWith(d);
});
}, 100);
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>harvester_e2e_tests.integrations.test_0_storage_network</code></h1>
</header>
<section id="section-intro">
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="harvester_e2e_tests.integrations.test_0_storage_network.cluster_network"><code class="name flex">
<span>def <span class="ident">cluster_network</span></span>(<span>request, api_client, unique_name)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@pytest.fixture(scope=&#39;module&#39;)
def cluster_network(request, api_client, unique_name):
    vlan_nic = request.config.getoption(&#39;--vlan-nic&#39;)
    assert vlan_nic, f&#34;VLAN NIC {vlan_nic} not configured correctly.&#34;

    code, data = api_client.clusternetworks.get_config()
    assert 200 == code, (code, data)

    node_key = &#39;network.harvesterhci.io/matched-nodes&#39;
    cnet_nodes = dict()  # cluster_network: items
    for cfg in data[&#39;items&#39;]:
        if vlan_nic in cfg[&#39;spec&#39;][&#39;uplink&#39;][&#39;nics&#39;]:
            nodes = json.loads(cfg[&#39;metadata&#39;][&#39;annotations&#39;][node_key])
            cnet_nodes.setdefault(cfg[&#39;spec&#39;][&#39;clusterNetwork&#39;], []).extend(nodes)

    code, data = api_client.hosts.get()
    assert 200 == code, (code, data)
    all_nodes = set(n[&#39;id&#39;] for n in data[&#39;data&#39;])
    try:
        # vlad_nic configured on specific cluster network, reuse it
        yield next(cnet for cnet, nodes in cnet_nodes.items() if all_nodes == set(nodes))
        return None
    except StopIteration:
        configured_nodes = reduce(add, cnet_nodes.values(), [])
        if any(n in configured_nodes for n in all_nodes):
            raise AssertionError(
                &#34;Not all nodes&#39; VLAN NIC {vlan_nic} are available.\n&#34;
                f&#34;VLAN NIC configured nodes: {configured_nodes}\n&#34;
                f&#34;All nodes: {all_nodes}\n&#34;
            )

    # Create cluster network
    cnet = f&#34;cnet-{datetime.strptime(unique_name, &#39;%Hh%Mm%Ss%f-%m-%d&#39;).strftime(&#39;%H%M%S&#39;)}&#34;
    created = []
    code, data = api_client.clusternetworks.create(cnet)
    assert 201 == code, (code, data)
    while all_nodes:
        node = all_nodes.pop()
        code, data = api_client.clusternetworks.create_config(node, cnet, vlan_nic, hostname=node)
        assert 201 == code, (
            f&#34;Failed to create cluster config for {node}\n&#34;
            f&#34;Created: {created}\t Remaining: {all_nodes}\n&#34;
            f&#34;API Status({code}): {data}&#34;
        )
        created.append(node)

    yield cnet

    # Teardown
    deleted = {name: api_client.clusternetworks.delete_config(name) for name in created}
    failed = [(name, code, data) for name, (code, data) in deleted.items() if 200 != code]
    if failed:
        fmt = &#34;Unable to delete VLAN Config {} with error ({}): {}&#34;
        raise AssertionError(
            &#34;\n&#34;.join(fmt.format(name, code, data) for (name, code, data) in failed)
        )

    code, data = api_client.clusternetworks.delete(cnet)
    assert 200 == code, (code, data)</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="harvester_e2e_tests.integrations.test_0_storage_network.test_storage_network"><code class="name flex">
<span>def <span class="ident">test_storage_network</span></span>(<span>api_client, cluster_network, vlan_id, unique_name, wait_timeout, setting_checker)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@pytest.mark.p0
@pytest.mark.settings
@pytest.mark.networks
@pytest.mark.skip_version_before(&#39;v1.0.3&#39;)
def test_storage_network(
    api_client, cluster_network, vlan_id, unique_name, wait_timeout, setting_checker
):
    &#39;&#39;&#39;
    To cover test:
    - https://harvester.github.io/tests/manual/_incoming/1055_dedicated_storage_network/

    Prerequisites:
        - All VMs should be halted
        - All nodes should be selected in cluster network
    Steps:
        1. Create VM Network with the VLAN ID to get CIDR
        2. Delete the VM Network
        3. Create Storage Network with the cluster network, VLAN ID and IP Range(CIDR)
        4. Verify Storage Network be configured
    Expected Result:
        - Status of Storage Network should be `reason: Completed` and `status:True`
        - Pods of Longhorn&#39;s instance manager should be `status.phase: Running`
        - And should have value `metadata.annotations: k8s.v1.cni.cncf.io/network-status`
        - And one of the value should contains `interface:lhnet1`
            - And the value of `ips` should be in the IP Range
    &#39;&#39;&#39;
    # Prerequisite: VMs should be shutting down
    code, data = api_client.vms.get_status()
    assert 200 == code, (code, data)
    assert not data[&#39;data&#39;], (
        &#34;\n&#34;.join(
            f&#34;VM({d[&#39;id&#39;]}) still in phase: {d[&#39;status&#39;][&#39;phase&#39;]}&#34;
            for d in data[&#39;data&#39;]
        )
    )

    # Get CIDR from VM Network
    code, data = api_client.networks.create(unique_name, vlan_id, cluster_network=cluster_network)
    assert 201 == code, (code, data)
    endtime = datetime.now() + timedelta(seconds=wait_timeout)
    while endtime &gt; datetime.now():
        code, data = api_client.networks.get(unique_name)
        annotations = data[&#39;metadata&#39;].get(&#39;annotations&#39;, {})
        if 200 == code and annotations.get(&#39;network.harvesterhci.io/route&#39;):
            route = json.loads(annotations[&#39;network.harvesterhci.io/route&#39;])
            if route[&#39;cidr&#39;]:
                break
        sleep(3)
    else:
        raise AssertionError(
            &#34;VM network created but route info not available\n&#34;
            f&#34;API Status({code}): {data}&#34;
        )
    _ = api_client.networks.delete(unique_name)
    vlan_cidr = route[&#39;cidr&#39;]

    # Create storage-network
    enable_spec = api_client.settings.StorageNetworkSpec.enable_with(
        vlan_id, cluster_network, vlan_cidr
    )
    code, data = api_client.settings.update(&#39;storage-network&#39;, enable_spec)
    assert 200 == code, (code, data)
    snet_enabled, (code, data) = setting_checker.wait_storage_net_enabled_on_harvester()
    assert snet_enabled, (code, data)
    snet_enabled, (code, data) = setting_checker.wait_storage_net_enabled_on_longhorn(vlan_cidr)
    assert snet_enabled, (code, data)

    # teardown
    disable_spec = api_client.settings.StorageNetworkSpec.disable()
    code, data = api_client.settings.update(&#39;storage-network&#39;, disable_spec)
    assert 200 == code, (code, data)
    snet_disabled, (code, data) = setting_checker.wait_storage_net_disabled_on_harvester()
    assert snet_disabled, (code, data)
    snet_disabled, (code, data) = setting_checker.wait_storage_net_disabled_on_longhorn()
    assert snet_disabled, (code, data)</code></pre>
</details>
<div class="desc"><p>To cover test:
- <a href="https://harvester.github.io/tests/manual/_incoming/1055_dedicated_storage_network/">https://harvester.github.io/tests/manual/_incoming/1055_dedicated_storage_network/</a></p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>All VMs should be halted</li>
<li>All nodes should be selected in cluster network</li>
</ul>
<h2 id="steps">Steps</h2>
<ol>
<li>Create VM Network with the VLAN ID to get CIDR</li>
<li>Delete the VM Network</li>
<li>Create Storage Network with the cluster network, VLAN ID and IP Range(CIDR)</li>
<li>Verify Storage Network be configured
Expected Result:<ul>
<li>Status of Storage Network should be <code>reason: Completed</code> and <code>status:True</code></li>
<li>Pods of Longhorn's instance manager should be <code>status.phase: Running</code></li>
<li>And should have value <code>metadata.annotations: k8s.v1.cni.cncf.io/network-status</code></li>
<li>And one of the value should contains <code>interface:lhnet1</code><ul>
<li>And the value of <code>ips</code> should be in the IP Range</li>
</ul>
</li>
</ul>
</li>
</ol></div>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="harvester_e2e_tests.integrations" href="index.html">harvester_e2e_tests.integrations</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="harvester_e2e_tests.integrations.test_0_storage_network.cluster_network" href="#harvester_e2e_tests.integrations.test_0_storage_network.cluster_network">cluster_network</a></code></li>
<li><code><a title="harvester_e2e_tests.integrations.test_0_storage_network.test_storage_network" href="#harvester_e2e_tests.integrations.test_0_storage_network.test_storage_network">test_storage_network</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.6</a>.</p>
</footer>
</body>
</html>
